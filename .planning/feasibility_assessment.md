# 自动监测终端命令可行性分析报告

## 1. 背景
当前规划采用“快捷键触发+读取剪贴板”的被动模式。用户提出了“自动监测终端输出”的需求，希望当CLI工具（如Claude Code）输出待确认命令时，Agent能自动介入。本报告旨在评估该需求的技术可行性。

## 2. 技术方案分析

### 方案A：终端代理模式 (Terminal Wrapper / Proxy) —— **推荐**
**原理**：
不直接运行目标工具，而是通过Agent启动。例如运行 `agent run claude`。Agent充当“中间人”，启动一个伪终端（Pseudo-Console / PTY）运行目标程序，实时捕获其标准输出（STDOUT）。

*   **工作流**：
    1. 用户执行 `agent run claude`。
    2. Agent利用 Windows ConPTY API 启动 `claude` 子进程。
    3. Agent 实时读取 `claude` 的字符流输出。
    4. 正则匹配特征（如识别到 "Risk: High" 或等待输入的提示符）。
    5. **触发**：一旦匹配成功，Agent暂停向子进程转发用户输入，先在界面下方或弹窗显示AI解释。
    6. 用户确认后，Agent恢复输入转发。

*   **优点**：
    *   **高准确性**：直接获取原始文本流，不受字体、背景色影响。
    *   **可拦截**：有能力阻止用户在阅读解释前误按回车（这是快捷键方案做不到的）。
    *   **跨终端**：无论你在CMD、PowerShell还是VSCode终端中运行 `agent run ...` 都可以工作。

*   **缺点**：
    *   **启动方式改变**：用户必须习惯 `agent run <cmd>` 而不是直接敲 `<cmd>`（可以通过 alias 缓解）。
    *   **开发复杂度高**：在Windows上完美处理伪终端、ANSI转义序列、窗口大小调整信号（SIGWINCH）较为复杂。
    *   **性能**：每一行输出都经过Python处理，可能有微小的延迟。

### 方案B：UI自动化监听 (Accessibility API)
**原理**：
使用 Windows UI Automation (UIA) 轮询当前活动窗口的内容。

*   **优点**：
    *   **无感**：用户无需改变启动命令习惯。

*   **缺点**：
    *   **极高噪音**：即时通讯软件、浏览器等任何文本变化都可能误触发。
    *   **难以定位上下文**：很难判断屏幕上哪一行是“最新的待确认命令”，哪一行是以前的日志。
    *   **性能开销大**：频繁查询UI树会占用CPU。
    *   **兼容性差**：在这个方案下，VSCode的集成终端、Windows Terminal、传统的conhost (cmd.exe) 的UI结构完全不同，适配工作量巨大。

### 方案C：Hook / 注入 (DLL Injection)
**原理**：
注入代码到终端进程。
*   **评估**：**不可行**。极易被杀毒软件拦截，且极其不稳定，容易导致终端崩溃。

## 3. 综合评估与结论

### 可行性结论
**完全可行**，但技术路径与当前规划的“快捷键”模式截然不同。

### 关键权衡 (Trade-off)
如果要实现“自动监测”，**方案A（终端代理）** 是唯一工业级可靠的路径。这一路径会将项目的定位从“辅助工具（Sidecar）”转变为“终端包装器（Wrapper）”。

| 维度 | 快捷键模式 (当前规划) | 终端代理模式 (自动监测) |
| :--- | :--- | :--- |
| **开发难度** | ⭐ (低) | ⭐⭐⭐ (高) |
| **用户习惯** | 需记忆快捷键 | 需改变启动命令 (需 alias) |
| **安全性** | 无论如何不影响原命令执行 | Agent崩溃可能导致原命令中断 |
| **拦截能力** | 无 (事后诸葛亮) | 有 (可暂停执行等待确认) |
| **精确度** | 依赖用户选准了文本 | 100% 精确捕获 |

### 分阶段开发建议

本评估已纳入项目的两阶段开发策略：

| 阶段 | 模式 | 对应方案 | 状态 |
|------|------|----------|------|
| **Phase 1** | 快捷键 + 剪贴板 | 当前规划 | ✅ 开发中 |
| **Phase 2** | 终端代理 | 方案A | 🔜 待需求评估后启动 |

**扩展性保障**：
- Phase 1 架构中已预留 `BaseCapturer` 抽象接口
- Phase 2 仅需新增 `TerminalProxyCapturer` 实现，无需重构核心模块
- 配置文件预留 `capturer.mode` 字段切换模式

---

> **结论**：本评估报告支撑了分阶段开发决策。Phase 1 聚焦核心功能验证，Phase 2 按需扩展自动监测能力。
